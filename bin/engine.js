// Generated by CoffeeScript 1.8.0
(function() {
  var React, ViewEngine, cjsx, html, jsx, merge;

  React = require('react');

  merge = require('./merge');

  html = require('js-beautify').html;

  cjsx = require('node-cjsx');

  jsx = require('node-jsx');

  ViewEngine = (function() {
    var noop;

    function ViewEngine() {}

    noop = function() {};

    ViewEngine.defaultEngineOptions = {
      doctype: '<!DOCTYPE html>',
      extension: '.cjsx',
      beautify: false
    };

    ViewEngine.createEngine = function(engineOptions) {
      this.engineOptions = merge(defaultEngineOptions, engineOptions);
      this.regexViewFileExtension = new RegExp("\\" + this.engineOptions.extension + "$");
      cjsx.transform();
      jsx.install({
        extension: '.jsx',
        harmony: true
      });
      return this.renderView;
    };

    ViewEngine.renderView = function(componentFileName, componentOptions, callback) {
      var componentFactory, componentFile, componentInstance, error, viewMarkup;
      if (callback == null) {
        callback = noop;
      }
      try {
        viewMarkup = this.engineOptions.doctype;
        componentFile = require(componentFileName);
        componentFactory = React.createFactory(componentFile);
        componentInstance = componentFactory(componentOptions);
        viewMarkup += React.renderToStaticMarkup(componentInstance);
      } catch (_error) {
        error = _error;
        callback(error);
        return false;
      }
      if (engineOptions.beautify) {
        viewMarkup = html(viewMarkup);
      }
      if (componentOptions.settings.env === 'development') {
        Object.keys(require.cache).forEach((function(_this) {
          return function(module) {
            if (_this.regexViewFileExtension.test(require.cache[module].filename)) {
              delete require.cache[module];
            }
          };
        })(this));
      }
      callback(null, viewMarkup);
    };

    return ViewEngine;

  })();

  module.exports = ViewEngine;

}).call(this);
